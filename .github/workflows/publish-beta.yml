name: Publish Beta Package

on:
  workflow_dispatch:
    inputs:
      package_name:
        description: 'Package name (e.g., @irfanandriansyah1997/compiler)'
        required: true
        type: string
      branch_name:
        description: 'Branch name for prerelease prefix (e.g., feature-xyz)'
        required: true
        type: string

jobs:
  publish-beta:
    runs-on: ubuntu-latest

    steps:
      - name: Validate inputs
        run: |
          BRANCH_NAME="${{ inputs.branch_name }}"
          PACKAGE_NAME="${{ inputs.package_name }}"
          
          if [ -z "$BRANCH_NAME" ]; then
            echo "âŒ Branch name is required"
            exit 1
          fi
          
          if [ -z "$PACKAGE_NAME" ]; then
            echo "âŒ Package name is required"
            exit 1
          fi
          
          # Sanitize branch name (replace / with -)
          SANITIZED_BRANCH=$(echo "$BRANCH_NAME" | sed 's/\//-/g' | sed 's/[^a-zA-Z0-9-]//g')
          echo "SANITIZED_BRANCH=$SANITIZED_BRANCH" >> $GITHUB_ENV
          echo "ðŸ“Œ Sanitized branch name: $SANITIZED_BRANCH"

      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch_name }}
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          registry-url: 'https://npm.pkg.github.com'
          scope: '@irfanandriansyah1997'

      - name: Create .npmrc
        run: |
          echo "auto-install-peers=true" > ~/.npmrc
          echo "//npm.pkg.github.com/:_authToken=${{ secrets.GH_BOT_RELEASE_TOKEN }}" >> ~/.npmrc
          echo "@tiket:registry=https://npm.pkg.github.com" >> ~/.npmrc
          echo "@irfanandriansyah1997:registry=https://npm.pkg.github.com" >> ~/.npmrc

      - name: Get package info and calculate beta version
        id: version
        run: |
          PACKAGE_NAME="${{ inputs.package_name }}"
          SANITIZED_BRANCH="${{ env.SANITIZED_BRANCH }}"
          
          # Get package directory
          PACKAGE_DIR=$(pnpm list --json --recursive --depth -1 | jq -r --arg name "$PACKAGE_NAME" '.[] | select(.name == $name) | .path')
          
          if [ -z "$PACKAGE_DIR" ]; then
            echo "âŒ Package $PACKAGE_NAME not found"
            exit 1
          fi
          
          echo "ðŸ“ Package directory: $PACKAGE_DIR"
          echo "PACKAGE_DIR=$PACKAGE_DIR" >> $GITHUB_OUTPUT
          
          # Get current version from package.json
          CURRENT_VERSION=$(jq -r '.version' "$PACKAGE_DIR/package.json")
          echo "ðŸ“¦ Current version: $CURRENT_VERSION"
          
          # Extract base version (remove any existing prerelease suffix)
          BASE_VERSION=$(echo "$CURRENT_VERSION" | sed 's/-.*//')
          echo "ðŸ”¢ Base version: $BASE_VERSION"
          
          # Find existing beta tags for this package and branch
          TAG_PREFIX="${PACKAGE_NAME}@${BASE_VERSION}-beta-${SANITIZED_BRANCH}"
          echo "ðŸ·ï¸  Looking for tags with prefix: $TAG_PREFIX"
          
          # Get the highest counter from existing tags
          HIGHEST_COUNTER=0
          for tag in $(git tag -l "${TAG_PREFIX}.*" 2>/dev/null); do
            # Extract counter from tag (e.g., @scope/pkg@1.0.0-branch.3 -> 3)
            COUNTER=$(echo "$tag" | grep -oE '\.[0-9]+$' | tr -d '.')
            if [ -n "$COUNTER" ] && [ "$COUNTER" -gt "$HIGHEST_COUNTER" ]; then
              HIGHEST_COUNTER=$COUNTER
            fi
          done
          
          # Increment counter
          NEXT_COUNTER=$((HIGHEST_COUNTER + 1))
          echo "ðŸ”„ Previous counter: $HIGHEST_COUNTER, Next counter: $NEXT_COUNTER"
          
          # Build the beta version
          BETA_VERSION="${BASE_VERSION}-beta-${SANITIZED_BRANCH}.${NEXT_COUNTER}"
          echo "ðŸš€ Beta version: $BETA_VERSION"
          
          # Build the tag name
          TAG_NAME="${PACKAGE_NAME}@${BETA_VERSION}"
          echo "ðŸ·ï¸  Tag name: $TAG_NAME"
          
          echo "BETA_VERSION=$BETA_VERSION" >> $GITHUB_OUTPUT
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "BASE_VERSION=$BASE_VERSION" >> $GITHUB_OUTPUT

      - name: Install dependencies
        run: |
          npm install -g pnpm@^10
          pnpm install

      - name: Update package version
        run: |
          PACKAGE_DIR="${{ steps.version.outputs.PACKAGE_DIR }}"
          BETA_VERSION="${{ steps.version.outputs.BETA_VERSION }}"
          
          echo "ðŸ“ Updating version to $BETA_VERSION in $PACKAGE_DIR/package.json"
          
          # Update version in package.json
          cd "$PACKAGE_DIR"
          npm version "$BETA_VERSION" --no-git-tag-version --allow-same-version

      - name: Build package
        run: |
          PACKAGE_NAME="${{ inputs.package_name }}"
          echo "ðŸ”¨ Building $PACKAGE_NAME..."
          pnpm --filter "$PACKAGE_NAME" build

      - name: Publish to GitHub Packages
        run: |
          PACKAGE_NAME="${{ inputs.package_name }}"
          BETA_VERSION="${{ steps.version.outputs.BETA_VERSION }}"
          
          echo "ðŸ“¤ Publishing $PACKAGE_NAME@$BETA_VERSION to GitHub Packages..."
          pnpm --filter "$PACKAGE_NAME" publish --access public --no-git-checks --tag beta
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GH_BOT_RELEASE_TOKEN }}

      - name: Create and push git tag
        run: |
          TAG_NAME="${{ steps.version.outputs.TAG_NAME }}"
          BETA_VERSION="${{ steps.version.outputs.BETA_VERSION }}"
          PACKAGE_NAME="${{ inputs.package_name }}"
          BRANCH_NAME="${{ inputs.branch_name }}"
          
          echo "ðŸ·ï¸  Creating tag: $TAG_NAME"
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Create annotated tag
          git tag -a "$TAG_NAME" -m "Beta release: $PACKAGE_NAME@$BETA_VERSION from branch $BRANCH_NAME"
          
          # Push tag
          git push origin "$TAG_NAME"
          
          echo "âœ… Tag $TAG_NAME created and pushed"
        env:
          GITHUB_TOKEN: ${{ secrets.GH_BOT_RELEASE_TOKEN }}

      - name: Summary
        run: |
          echo "## ðŸ§ª Beta Publish Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Package:** ${{ inputs.package_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.version.outputs.BETA_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ inputs.branch_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** ${{ steps.version.outputs.TAG_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¥ Install" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "pnpm add ${{ inputs.package_name }}@${{ steps.version.outputs.BETA_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Or using the beta tag:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "pnpm add ${{ inputs.package_name }}@beta" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Successfully published beta to GitHub Packages!" >> $GITHUB_STEP_SUMMARY

